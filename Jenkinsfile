pipeline {

    agent none

    environment {

        BUILD_DIR = '/var/www/react-app'

    }

    stages {

        stage('Checkout') {

            agent { label 'ec2-production' }

            steps {

                echo 'üì• Checking out React code from GitHub...'

                checkout scm

            }

        }

        stage('Install Dependencies') {

            agent { label 'ec2-production' }

            steps {

                echo 'üì¶ Installing npm dependencies...'

                sh '''

                    # Clean install

                    rm -rf node_modules package-lock.json

                    npm install

                '''

            }

        }

        stage('Build React App') {

            agent { label 'ec2-production' }

            steps {

                echo 'üî® Building React production build...'

                sh '''

                    # Build for production

                    npm run build

                    # Check if build was successful

                    if [ ! -d "build" ]; then

                        echo "‚ùå Build directory not found!"

                        exit 1

                    fi

                    echo "‚úÖ Build completed successfully"

                    ls -la build/

                '''

            }

        }

        stage('Deploy to Nginx') {

            agent { label 'ec2-production' }

            steps {

                echo 'üöÄ Deploying to Nginx...'

                sh '''

                    # Backup existing deployment (optional)

                    if [ -d "${BUILD_DIR}" ]; then

                        sudo rm -rf ${BUILD_DIR}.backup

                        sudo cp -r ${BUILD_DIR} ${BUILD_DIR}.backup || true

                    fi

                    # Clear old deployment

                    sudo rm -rf ${BUILD_DIR}/*

                    # Copy new build files

                    sudo cp -r build/* ${BUILD_DIR}/

                    # Set correct permissions

                    sudo chown -R www-data:www-data ${BUILD_DIR}

                    sudo chmod -R 755 ${BUILD_DIR}

                    # Reload Nginx

                    sudo systemctl reload nginx

                    echo "‚úÖ Deployment completed!"

                '''

            }

        }

        stage('Health Check') {

            agent { label 'ec2-production' }

            steps {

                echo 'üè• Checking deployment health...'

                sh '''

                    sleep 2

                    # Check if Nginx is serving the app

                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)

                    if [ "$HTTP_CODE" = "200" ]; then

                        echo "‚úÖ React app is accessible (HTTP $HTTP_CODE)"

                    else

                        echo "‚ùå React app is not accessible (HTTP $HTTP_CODE)"

                        exit 1

                    fi

                '''

            }

        }

    }

    post {

        success {

            echo '‚úÖ Pipeline completed successfully!'

            echo 'üåê React App: http://65.0.124.193'

            echo 'üîó FastAPI Backend: http://3.110.177.17:8000'

            echo 'üìñ API Docs: http://3.110.177.17:8000/docs'

        }

        failure {

            echo '‚ùå Pipeline failed!'

            echo 'üîç Check logs: sudo journalctl -u nginx -n 50'

        }

        always {

            echo 'üìä Build finished at: ' + new Date().toString()

        }

    }

}
 
